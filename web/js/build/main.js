var cookieStoryApp=angular.module("cookieStoryApp",["ui.router","ngFileUpload","ngResource"]);cookieStoryApp.constant("_",window._),cookieStoryApp.config(function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"views/home.html",controller:"ListeRecetteCtrl",resolve:{Recettes:function(RecetteService){return RecetteService.listeRecette().then(function(result){return result.data})},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}}).state("connexion",{url:"/connect",templateUrl:"views/connexion.html",controller:"ConnexionCtrl",resolve:{Admin:function(AdminService){return null}}}).state("recette",{url:"/recette/{slug}",templateUrl:"views/recette.html",controller:"RecetteCtrl",resolve:{Recette:function($stateParams,RecetteService){return RecetteService.getRecette($stateParams.slug).then(function(result){return result.data},function(){},function(){})},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}}).state("indexRecette",{url:"/index",templateUrl:"views/index.html",controller:"ListeRecetteCtrl",resolve:{Recettes:function(RecetteService){return RecetteService.listeRecette().then(function(result){return result.data})},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}}).state("categories",{url:"/categories",templateUrl:"views/categories.html",controller:"ListeRecetteCtrl",resolve:{Recettes:function(RecetteService){return RecetteService.listeRecette().then(function(result){return result.data})},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}}).state("categorieListeRecette",{url:"/categorie/{slug}",templateUrl:"views/categorieListeRecette.html",controller:"ListeRecetteCtrl",resolve:{Recettes:function(RecetteService,$stateParams){return RecetteService.listeRecetteByTag($stateParams.slug).then(function(result){return result.data})},Tags:function(){return[]}}}).state("admin",{url:"/admin",abstract:!0,templateUrl:"views/admin.html",data:{authorizedRights:["admin.read"],redirect:"connexion"}}).state("admin.pageAdmin",{url:"/gestion",templateUrl:"views/pageAdmin.html",controller:"adminCtrl",resolve:{Recettes:function(RecetteService){return RecetteService.listeRecette().then(function(result){return result.data})},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}}).state("admin.newRecette",{url:"/recette",templateUrl:"views/add.recette.html",controller:"RecetteCtrl",resolve:{Recette:function(){return null},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}}).state("admin.modifierRecette",{url:"/modifRecette/{slug}",templateUrl:"views/add.recette.html",controller:"RecetteCtrl",resolve:{Recette:function($stateParams,RecetteService){return RecetteService.getRecette($stateParams.slug).then(function(result){return result.data},function(){},function(){})},Tags:function(RecetteService){return RecetteService.listeTags().then(function(result){return result.data})}}})}),cookieStoryApp.run(function($state,AuthService,$rootScope){$rootScope.$on("$stateChangeStart",function(event,next,nextParams,fromState){if("data"in next&&"authorizedRights"in next.data){var authorizedRights=next.data.authorizedRights;AuthService.isAuthorized(authorizedRights)||(event.preventDefault(),$state.go(next.data.redirect))}}),$rootScope.$on("$stateChangeSuccess",function(){document.body.scrollTop=document.documentElement.scrollTop=0})}),cookieStoryApp.filter("reverse",function(){return function(input){return input.slice().reverse()}}),cookieStoryApp.filter("lettre",function(){return function(input,lettre){var myRegex=new RegExp("^"+lettre,"i"),filtre=function(element){if(myRegex.test(element.titre))return element};return input.filter(filtre)}}),$(document).ready(function(){var limitScrollTop=parseInt($(".bandeau").offset().top);$(document).scrollTop()>=limitScrollTop&&$(".bandeau").css({position:"sticky",top:"0","z-index":"100"}),$(window).scroll(function(){$(document).scrollTop()>=limitScrollTop?$(".bandeau").css({position:"fixed",top:"0","z-index":"100",width:"85%"}).siblings().css({"margin-top":"50px"}):$(".bandeau").css({position:"initial","z-index":"0",width:"100%"}).siblings().css({"margin-top":"0px"})})}),cookieStoryApp.controller("adminCtrl",["$scope","$state","RecetteService","Recettes","Tags","Upload",function($scope,$state,RecetteService,Recettes,Tags,Upload){$scope.recettes=Recettes,$scope.tags=Tags,$scope.newRecette=function(){$state.go("admin.newRecette")},$scope.modifierRecette=function(recette){$state.go("admin.modifierRecette",{slug:recette.slug})},$scope.deleteRecette=function(recette){RecetteService.deleteRecette(recette.id).then(function(){$state.reload()})},$scope.deleteTag=function(tag){RecetteService.removeTag(tag.id).then(function(){$state.reload()})},$scope.saveTag=function(){RecetteService.addTag($scope.tag).then(function(){$state.reload()})},$scope.uploadPic=function(file){file.upload=Upload.upload({url:"upload",method:"POST",file:file}),file.upload.then(function(response){response.data.success?($scope.tag.image=response.data.path,$scope.picFile=void 0):console.log(response)},function(response){},function(evt){file.progress=Math.min(100,parseInt(100*evt.loaded/evt.total))})}}]),cookieStoryApp.controller("ConnexionCtrl",["$scope","$state","Admin","AuthService",function($scope,$state,Admin,AuthService){$scope.connexion=function(identifiant,password){var admin={identifiant:identifiant,password:password};AuthService.login(admin).then(function(response){response.data.id&&$state.go("admin.pageAdmin")})}}]),cookieStoryApp.controller("feedCtrl",["$scope","FeedService",function($scope,FeedService){$scope.images=[],FeedService.getFeed().then(function(res){res.data.data.forEach(function(data){var image={link:data.link,src:data.images.thumbnail.url};$scope.images.push(image)})})}]),cookieStoryApp.controller("ListeRecetteCtrl",["$scope","$state","RecetteService","Recettes","Tags",function($scope,$state,RecetteService,Recettes,Tags){$scope.alphabet=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],$scope.recettes=Recettes,$scope.tags=Tags}]),cookieStoryApp.controller("RecetteCtrl",["$scope","$state","Upload","RecetteService","Recette","Tags",function($scope,$state,Upload,RecetteService,Recette,Tags){if($scope.recette=Recette||{commentaires:[],tags:[]},$scope.tags=Tags,$scope.countCommentaire=$scope.recette.commentaires.length,$scope.contenuText="",$scope.contenuList=[],Recette){$scope.layout=Recette.layout;var position=Math.max.apply(null,Recette.layout.map(function(o){return o.position}))+1}else{$scope.layout=[];var position=1}$scope.addElement=function(element,contenu,pos){"titre"==element&&($scope.layout.push({item:"titre",position:pos||position,contenu:contenu}),$scope.recette.titre=contenu),"imageH"==element&&$scope.layout.push({item:"imageH",position:pos||position,contenu:contenu}),"story"==element&&$scope.layout.push({item:"story",position:pos||position,contenu:contenu}),"recette"==element&&$scope.layout.push({item:"recette",position:pos||position,contenu:contenu}),"ingredients"==element&&$scope.layout.push({item:"ingredients",position:pos||position,contenu:contenu}),position++,$scope.contenuText="",$scope.contenuList=[],$scope.positionEdition=void 0,trierLayoutParPosition()},$scope.deleteElement=function(position){$scope.layout.splice(position,1),trierLayoutParPosition()},$scope.modifierElement=function(element,index){"titre"!=element.item&&"story"!=element.item||($scope.contenuText=element.contenu,$scope.layout.splice(index,1),$scope.positionEdition=element.position),"ingredients"!=element.item&&"recette"!=element.item||($scope.contenuList=element.contenu,$scope.layout.splice(index,1),$scope.positionEdition=element.position),trierLayoutParPosition()},$scope.monterElement=function(position){var positionTmp=$scope.layout[position].position;$scope.layout[position].position=$scope.layout[--position].position,$scope.layout[position].position=positionTmp,trierLayoutParPosition()},$scope.descendreElement=function(position){var positionTmp=$scope.layout[position].position;$scope.layout[position].position=$scope.layout[++position].position,$scope.layout[position].position=positionTmp,trierLayoutParPosition()};var trierLayoutParPosition=function(){$scope.layout=$scope.layout.sort(function(elementA,elementB){return elementA.position<elementB.position?-1:1})};$scope.addCommentaire=function(form){if(form.$valid){var commentaire={pseudo:$scope.pseudo,contenu:$scope.contenu,mail:$scope.mail,website:$scope.website,recetteId:$scope.recette.id};RecetteService.saveCommentaire(commentaire).then(function(){$state.reload()})}},$scope.addRecette=function(){var recette={titre:$scope.recette.titre,layout:$scope.layout};$scope.recette.id&&(recette.id=$scope.recette.id),RecetteService.saveRecette(recette).then(function(){$state.go("admin.pageAdmin")})},$scope.deleteRecette=function(){RecetteService.deleteRecette($scope.recette.id).then(function(){$state.go("home")})},$scope.addTagToRecette=function(tag){RecetteService.addTagToRecette(tag.id,$scope.recette.id).then(function(response){$scope.recette.tags.push(tag)})},$scope.removeTagFromRecette=function(tag){RecetteService.removeTagFromRecette(tag.id,$scope.recette.id).then(function(response){$scope.recette.tags.sort(function(tagA,tagB){return tagB.id==tag.id}).shift()})},$scope.uploadPic=function(file){file.upload=Upload.upload({url:"upload",method:"POST",file:file}),file.upload.then(function(response){response.data.success&&($scope.addElement("imageH",response.data.path),$scope.picFile=void 0)},function(response){},function(evt){file.progress=Math.min(100,parseInt(100*evt.loaded/evt.total))})},$scope.isNotSelectedTag=function(tag){return!$scope.recette.tags.some(function(tagRecette){return tagRecette.id==tag.id})}}]),cookieStoryApp.directive("csCommentaires",function(){return{restrict:"EC",replace:!0,scope:{elements:"=elements"},templateUrl:"js/templates/commentaires.html"}}),cookieStoryApp.directive("csImageH",function(){return{restrict:"EC",replace:!0,scope:{image:"=image"},template:"<div class='col-xs-12'><img ng-src={{image}}></img></div>"}}),cookieStoryApp.directive("csImageV",function(){return{restrict:"EC",replace:!0,scope:{image:"=image"},template:"<div class='col-xs-6'><img ng-src={{image}}></img></div>"}}),cookieStoryApp.directive("csIngredients",function(){return{restrict:"EC",replace:!0,scope:{elements:"=elements"},templateUrl:"js/templates/ingredients.html"}}),cookieStoryApp.directive("csRecette",function(){return{restrict:"EC",replace:!0,scope:{elements:"=elements"},templateUrl:"js/templates/recette.html"}}),cookieStoryApp.directive("csStory",function(){return{restrict:"EC",replace:!0,scope:{story:"=story"},template:"<div class='col-xs-12'><h2>Il etait une fois...</h2><div>{{story}}</div></div>"}}),cookieStoryApp.directive("csTitre",function(){return{restrict:"EC",replace:!0,scope:{titre:"=titre"},template:"<div class='col-xs-12'><h1>{{titre}}</h1></div>"}}),cookieStoryApp.service("AdminService",["$http",function($http){this.connexion=function(admin){return $http.post("admin/connect",{admin:admin})}}]),cookieStoryApp.service("AuthService",["$resource","$http","$q","_",function($resource,$http,$q,_){function setUser(value){user=value,localStorage.setItem("auth_user",JSON.stringify(user))}function setRoles(values){roles=values,localStorage.setItem("auth_roles",JSON.stringify(roles))}function setRights(values){rights=values,localStorage.setItem("auth_rights",JSON.stringify(rights))}var user=JSON.parse(localStorage.getItem("auth_user")),roles=JSON.parse(localStorage.getItem("auth_roles")),rights=JSON.parse(localStorage.getItem("auth_rights"));this.login=function(admin){var deferred=$q.defer();return $http.post("admin/connect",{admin:admin}).then(function(response){var user=response.data;user.id?(setUser(user),setRoles(["SUPER_ADMIN"]),setRights(["admin.read"]),deferred.resolve(response)):deferred.reject(response)},function(response){var err=response.data;deferred.reject(err)}),deferred.promise},this.logout=function(){return setUser(null),setRoles([]),setRights([]),$http.get("auth/logout")},this.isAuthenticated=function(){return null!==user},this.isAuthorized=function(authorizedRights){return 0==authorizedRights.length||_.intersection(rights,authorizedRights).length>0},this.getAuthenticatedUser=function(){return user}}]),cookieStoryApp.service("FeedService",["$http",function($http){this.getFeed=function(admin){return $http.get("feed")}}]),cookieStoryApp.service("RecetteService",["$http",function($http){this.getRecette=function(slug){return $http.get("recette/find?slug="+slug)},this.getTag=function(slug){return $http.get("tag/find?slug="+slug)},this.listeRecette=function(){return $http.get("recette/liste")},this.listeRecetteByTag=function(tagSlug){return $http.get("recette/tag?slug="+tagSlug)},this.listeTags=function(){return $http.get("tags/liste")},this.saveRecette=function(recette){return $http.post("recette/save",{recette:recette})},this.deleteRecette=function(id){return $http.delete("recette/delete?id="+id)},this.saveCommentaire=function(commentaire){return $http.post("recette/saveCommentaire",{commentaire:commentaire})},this.addTag=function(tag){return $http.post("saveTag",{tag:tag})},this.removeTag=function(tag){return $http.post("removeTag",{tag:tag})},this.addTagToRecette=function(tag,recette){return $http.post("saveTagToRecette",{tag:tag,recette:recette})},this.removeTagFromRecette=function(tag,recette){return $http.post("removeTagFromRecette",{tag:tag,recette:recette})}}]);
//# sourceMappingURL=main.js.map